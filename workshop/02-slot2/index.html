
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../01-slot1/">
      
      
        <link rel="next" href="../03-slot3/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.9">
    
    
      
        <title>Slot 2: Augmented Generation - Extending Hosted LLMs with Local Documents - Quarkus LLM Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#slot-2-augmented-generation-extending-hosted-llms-with-local-documents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You are not viewing the latest version.
<a href="../../..">
    <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Quarkus LLM Workshop" class="md-header__button md-logo" aria-label="Quarkus LLM Workshop" data-md-component="logo">
      
  <img src="../../assets/quarkus-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quarkus LLM Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Slot 2: Augmented Generation - Extending Hosted LLMs with Local Documents
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6v1m7-4.68V17c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-2.26C3.19 13.47 2 11.38 2 9c0-3.87 3.13-7 7-7 1.65 0 3.16.57 4.35 1.5C10.8 4.57 9 7.07 9 10c0 2.79 1.64 5.19 4 6.32m7.92-6.38-1.42-.91-1.4.97.4-1.65-1.33-1.03 1.68-.11.56-1.61.63 1.58 1.68.04-1.3 1.08.5 1.64M19.39 13c-1.89 2.27-5.36 2.19-7.17-.05C10 10.13 11.56 6 15 5.34c.34-.05.64.29.5.63-.45 1.28-.38 2.74.35 4a4.622 4.622 0 0 0 3.27 2.28c.35.05.5.49.27.75Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1h4m6-10h3v2h-3v-2M1 11h3v2H1v-2M13 1v3h-2V1h2M4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93 4.92 3.5m12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12-1.42-1.42Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cescoffier/quarkus-llm-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Quarkus LLM Workshop" class="md-nav__button md-logo" aria-label="Quarkus LLM Workshop" data-md-component="logo">
      
  <img src="../../assets/quarkus-logo.png" alt="logo">

    </a>
    Quarkus LLM Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cescoffier/quarkus-llm-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Workshop
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Workshop
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-slot1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Slot 1: Unveiling the Potential - Integrating OpenAI with Quarkus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Slot 2: Augmented Generation - Extending Hosted LLMs with Local Documents
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Slot 2: Augmented Generation - Extending Hosted LLMs with Local Documents
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-llama2-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Running LLAMA2 locally
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running LLAMA2 locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-llama2" class="md-nav__link">
    <span class="md-ellipsis">
      Installing LLAMA2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-hosted-llama-2-model" class="md-nav__link">
    <span class="md-ellipsis">
      Using a hosted LLama 2 model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-chat-application" class="md-nav__link">
    <span class="md-ellipsis">
      The Chat Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-llama2" class="md-nav__link">
    <span class="md-ellipsis">
      Using LLAMA2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-chat-bot" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the Chat Bot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing the Chat Bot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-ai-service" class="md-nav__link">
    <span class="md-ellipsis">
      The AI Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-the-state-of-the-conversation" class="md-nav__link">
    <span class="md-ellipsis">
      Handling the State of the Conversation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-websocket-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      The WebSocket Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      The Frontend
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extending-the-llm-with-local-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Extending the LLM with Local Documents
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Extending the LLM with Local Documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ingesting-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting Documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-rag-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the RAG Pattern
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-slot3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Slot 3: Deploying an LLM using OpenShift AI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-slot4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Slot 4: Utilizing a model deployed on OpenShift AI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Appendixes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Appendixes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/installing-curl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing cURL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/installing-docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing Docker or Podman
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/installing-jdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing Java 17.0.9
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/installing-wsl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing WSL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/installing-ollama/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing LLAMA2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendixes/accessing-azureai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing Azure OpenAI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#running-llama2-locally" class="md-nav__link">
    <span class="md-ellipsis">
      Running LLAMA2 locally
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running LLAMA2 locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-llama2" class="md-nav__link">
    <span class="md-ellipsis">
      Installing LLAMA2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-hosted-llama-2-model" class="md-nav__link">
    <span class="md-ellipsis">
      Using a hosted LLama 2 model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-chat-application" class="md-nav__link">
    <span class="md-ellipsis">
      The Chat Application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-llama2" class="md-nav__link">
    <span class="md-ellipsis">
      Using LLAMA2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-chat-bot" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the Chat Bot
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing the Chat Bot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-ai-service" class="md-nav__link">
    <span class="md-ellipsis">
      The AI Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-the-state-of-the-conversation" class="md-nav__link">
    <span class="md-ellipsis">
      Handling the State of the Conversation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-websocket-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      The WebSocket Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      The Frontend
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extending-the-llm-with-local-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Extending the LLM with Local Documents
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Extending the LLM with Local Documents">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ingesting-documents" class="md-nav__link">
    <span class="md-ellipsis">
      Ingesting Documents
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-rag-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the RAG Pattern
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/cescoffier/quarkus-llm-workshop/edit/main/docs/content/workshop/02-slot2.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<h1 id="slot-2-augmented-generation-extending-hosted-llms-with-local-documents">Slot 2: Augmented Generation - Extending Hosted LLMs with Local Documents<a class="headerlink" href="#slot-2-augmented-generation-extending-hosted-llms-with-local-documents" title="Permanent link">#</a></h1>
<p>In this section, we will:</p>
<ol>
<li><strong>Shift gears:</strong> Explore another LLM and extend its capabilities using local documents.</li>
<li><strong>Retrieval Augmented Generation:</strong> Delve into one of the core patterns in AI usage, understanding the synergy between your data and LLM interactions.</li>
</ol>
<p><img alt="Retrieval augmented generation with Quarkus" src="../../assets/rag.jpg" /></p>
<p>We are going to build a chatbot that will use a pre-trained LLM (llama2) to generate responses.
We will then extend the LLM with local documents to improve the quality of the responses.</p>
<h2 id="running-llama2-locally">Running LLAMA2 locally<a class="headerlink" href="#running-llama2-locally" title="Permanent link">#</a></h2>
<p>In the previous slot, we used the OpenAI GPT model.
The model is running remotely.
It can become a security concern if you want to use the model for sensitive data, especially when using local documents to extend the knowledge of the LLM.
Thus, here, we will run the model locally.</p>
<p>If for any reason, you are not able to run the model locally, you can use a hosted LLAMA2 model.
Jump to the <a href="#using-a-hosted-llama-2-model">Using a hosted LLama 2 model</a> section.</p>
<h3 id="installing-llama2">Installing LLAMA2<a class="headerlink" href="#installing-llama2" title="Permanent link">#</a></h3>
<p>If not already done, install LLAMA2 use <a href="https://ollama.ai/">ollama</a> following the instructions <a href="../../appendixes/installing-ollama/">discribed in the appendix</a>).</p>
<p>Once installed with Ollama up and running, you should have access to the <code>ollama</code> command line tool:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$<span class="w"> </span>ollama<span class="w"> </span>--version
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>ollama<span class="w"> </span>version<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.1.17
</code></pre></div>
<p>Ollama can run multiple models, as you can see on <a href="https://ollama.ai/library">ollama&rsquo;s library</a>.
We will use the <code>llama2</code> model, which is a GPT-2 model trained on a large corpus of text.</p>
<p>Pull the model using:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>$<span class="w"> </span>ollama<span class="w"> </span>pull<span class="w"> </span>llama2<span class="w"> </span>
</code></pre></div>
<details class="warning" open="open">
<summary>Warning</summary>
<p>The <a href="https://ollama.ai/library/llama2">LLAMA2</a> model is quite large (&gt; 3.8GB). Make sure you have enough disk space.</p>
</details>
<p>Once pulled, we will be able to use it.</p>
<h3 id="using-a-hosted-llama-2-model">Using a hosted LLama 2 model<a class="headerlink" href="#using-a-hosted-llama-2-model" title="Permanent link">#</a></h3>
<p>If you are not able to run the model locally, you can use a hosted <a href="https://huggingface.co/meta-llama/Llama-2-7b-chat-hf">LLAMA2</a> model.
To do so, you need to:</p>
<ul>
<li>Define the Hugging Face API key provided in the companion document:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">HUGGINGFACE_API_KEY</span><span class="o">=</span>&lt;Your<span class="w"> </span>HuggingFace<span class="w"> </span>token&gt;
</code></pre></div>
<ul>
<li>Then, in the rest of the section, you will use the <code>chat-application-hugging-face</code> directory instead of the <code>chat-application</code> directory.
It uses a hugging face inference point providing the LLama2 model. 
The configuration and dependencies are slightly different from the ones described in the rest of the section.</li>
</ul>
<h3 id="the-chat-application">The Chat Application<a class="headerlink" href="#the-chat-application" title="Permanent link">#</a></h3>
<p>As mentioned above, we will build a chatbot.
Navigate to the <code>chat-application</code> directory to see the full source code of the application.</p>
<p>All the paths in the rest of this document are related to that directory.</p>
<h3 id="using-llama2">Using LLAMA2<a class="headerlink" href="#using-llama2" title="Permanent link">#</a></h3>
<p>Open the <code>pom.xml</code> file and check that you have the following dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-resteasy-reactive-jackson<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-websockets<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkiverse.langchain4j<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-langchain4j-ollama<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>${quarkus-langchain.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<p>The first dependency is the RESTEasy Reactive Jackson extension.
The second dependency is used to add the WebSocket support, as the UI will use the WebSocket protocol to communicate with the application.</p>
<p>Finally, the last dependency adds support for Ollama.</p>
<p>In the <code>src/main/resources/application.properties</code> file, we have the following configuration:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="na">quarkus.langchain4j.ollama.chat-model.model-id</span><span class="o">=</span><span class="s">llama2</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="na">quarkus.langchain4j.ollama.timeout</span><span class="o">=</span><span class="s">60s</span>
</code></pre></div>
<p>The first property is used to specify the model to use.
In our case, we will use the <code>llama2</code> model.
The second property configures the timeout for the model.</p>
<details class="tip" open="open">
<summary>Logging the request and response</summary>
<p>If you want to visualise the request that is sent to the model and its response, you cam increase the log level by adding the following properties to the <code>src/main/resources/application.properties</code> file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="na">quarkus.langchain4j.ollama.log-requests</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="na">quarkus.langchain4j.ollama.log-responses</span><span class="o">=</span><span class="s">true</span>
</code></pre></div>
</details>
<p>Alright, it&rsquo;s time to implement the chatbot part.</p>
<h2 id="implementing-the-chat-bot">Implementing the Chat Bot<a class="headerlink" href="#implementing-the-chat-bot" title="Permanent link">#</a></h2>
<p>The chat bot is composed of two parts:</p>
<ul>
<li>the AI service, which will generate the response</li>
<li>the WebSocket endpoint, which will handle communication with the UI</li>
</ul>
<h3 id="the-ai-service">The AI Service<a class="headerlink" href="#the-ai-service" title="Permanent link">#</a></h3>
<p>The AI service is located in the <code>io.quarkiverse.langchain4j.workshop.chat.ChatService</code> class:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.workshop.chat</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.MemoryId</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.SystemMessage</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.UserMessage</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.RegisterAiService</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Singleton</span><span class="p">;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="nd">@RegisterAiService</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="nd">@Singleton</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ChatService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="nd">@SystemMessage</span><span class="p">(</span><span class="s">&quot;&lt;&lt;SYS&gt;&gt;You are a chat bot answering customer requests about bank products.&lt;&lt;/SYS&gt;&gt;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span><span class="nd">@UserMessage</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="s">        Answer the customer request. The answer must be polite and relevant to the question.</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="s">        When you don&#39;t know, respond that you don&#39;t know the answer, and the bank will contact the customer directly.</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="s">        +++</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="s">        {message}</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="s">        +++</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">chat</span><span class="p">(</span><span class="nd">@MemoryId</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>ChatService</code> interface is annotated with <code>@RegisterAiService</code> to indicate that it is an AI service.
The <code>@Singleton</code> annotation is used to indicate that the service is a singleton.
This is required when used from a WebSocket.</p>
<p>It contains a single method, <code>chat</code>, which is annotated with <code>@SystemMessage</code> and <code>@UserMessage</code>.
The system message is wrapped into <code>&lt;&lt;SYS&gt;&gt;</code> and <code>&lt;&lt;\SYS&gt;&gt;</code>.
This is a requirement from the LLAMA2 model.</p>
<p>The user message is a template that will be used to generate the response.
The <code>+++</code> and <code>+++</code> are used to delimit the message from the user.
Also note the <code>{message}</code> placeholder.
It is replaced with the user message received as a parameter.</p>
<h3 id="handling-the-state-of-the-conversation">Handling the State of the Conversation<a class="headerlink" href="#handling-the-state-of-the-conversation" title="Permanent link">#</a></h3>
<p>When interacting with a chat bot, we do not want to lose the context of the conversation.
However, the LLM does not store the context of the conversation; it is stateless.</p>
<p>Thus, we need to send the context of the conversation to the LLM every time we send a message.
The context is a set of messages exchanged between the user and the chat bot.</p>
<p>As you may have noticed, the <code>chat</code> method also receives a <code>session</code> parameter (which will be the WebSocket connection).
The parameter is annotated with <code>@MemoryId</code>, indicating that this object will be used to store the state of the conversation.</p>
<p>We need to provide a CDI bean implementing the <code>ChatMemoryProvider</code> interface:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.workshop.chat</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.memory.ChatMemory</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.memory.chat.ChatMemoryProvider</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.memory.chat.MessageWindowChatMemory</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChatMemoryBean</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ChatMemoryProvider</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">ChatMemory</span><span class="o">&gt;</span><span class="w"> </span><span class="n">memories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ChatMemory</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">memoryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">memories</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">memoryId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MessageWindowChatMemory</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">                </span><span class="p">.</span><span class="na">maxMessages</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">                </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">memoryId</span><span class="p">)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">        </span><span class="n">memories</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="p">}</span>
</code></pre></div>
<details class="info" open="open">
<summary>Info</summary>
<p>Because we have a single <code>ChatMemoryProvider</code>, we do not have to configure anything.
When you have multiple ones, you can configure the one to use with the <code>chatMemoryProvider</code> attribute of the <code>@RegisterAiService</code> annotation.</p>
</details>
<p>For each <em>memory id</em>, we create and retrieve a <code>ChatMemory</code> object.
This object is used to store the context of the conversation for that specific <em>memory id</em>.
In the code above, we only store 20 messages.
Note that the bigger this context, the slower the response time.
Even 20 can be too much.</p>
<p>The <code>clear</code> method is used to remove the memory when the WebSocket connection is closed.
That&rsquo;s what we are going to see now.</p>
<h3 id="the-websocket-endpoint">The WebSocket Endpoint<a class="headerlink" href="#the-websocket-endpoint" title="Permanent link">#</a></h3>
<p>The second part is the WebSocket endpoint:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.workshop.chat</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.infrastructure.Infrastructure</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.control.ActivateRequestContext</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.websocket.*</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.websocket.server.ServerEndpoint</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.IOException</span><span class="p">;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="s">&quot;/chatbot&quot;</span><span class="p">)</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChatBotWebSocket</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span><span class="n">ChatService</span><span class="w"> </span><span class="n">chat</span><span class="p">;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">    </span><span class="n">ChatMemoryBean</span><span class="w"> </span><span class="n">chatMemoryBean</span><span class="p">;</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">    </span><span class="nd">@OnClose</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">        </span><span class="n">chatMemoryBean</span><span class="p">.</span><span class="na">clear</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">    </span><span class="nd">@OnMessage</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">        </span><span class="n">Infrastructure</span><span class="p">.</span><span class="na">getDefaultExecutor</span><span class="p">().</span><span class="na">execute</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chat</span><span class="p">.</span><span class="na">chat</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">                </span><span class="n">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="p">}</span>
</code></pre></div>
<p>It is annotated with <code>@ServerEndpoint</code> to indicate that it is a WebSocket endpoint.
The endpoint is available at the <code>/chatbot</code> path, so you can connect to the WebSocket using <code>ws://localhost:8080/chatbot</code>.</p>
<details class="tip" open="open">
<summary>Tip</summary>
<p>You can check if the port 8080 is already used by another process with the command <code>lsof -i tcp:8080</code>.</p>
</details>
<p>The <code>ChatBotWebSocket</code> bean receives the <code>ChatService</code> as well as the <code>ChatMemoryBean</code> bean.
The <code>onClose</code> method is called when the WebSocket connection is closed.
It is used to remove the memory associated with the session.</p>
<p>The <code>onMessage</code> method is called when a message is received.
It uses the <code>ChatService</code> to generate the response and sends it back to the client.</p>
<details class="bug" open="open">
<summary>Bug</summary>
<p>Due to a Quarkus WebSocket limitation, we need to use <code>Infrastructure.getDefaultExecutor().execute</code> to execute the code in a different thread; otherwise, the WebSocket connection will block the event loop.</p>
</details>
<h3 id="the-frontend">The Frontend<a class="headerlink" href="#the-frontend" title="Permanent link">#</a></h3>
<p>The frontend is located in the <code>src/main/resources/META-INF/resources/index.html</code> file.
Nothing very fancy.</p>
<p>Start the application using:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$<span class="w"> </span>./mvnw<span class="w"> </span>quarkus:dev
</code></pre></div>
<p>Then, open your browser at <a href="http://localhost:8080">http://localhost:8080</a> and click on the chat bot link (bottom right).
You can start chatting with the bot.
If you ask questions about the products offered by the bank, the bot will answer.
But how does it get this knowledge?
That&rsquo;s what we are going to see next.</p>
<h2 id="extending-the-llm-with-local-documents">Extending the LLM with Local Documents<a class="headerlink" href="#extending-the-llm-with-local-documents" title="Permanent link">#</a></h2>
<p>In this section, we will extend the LLM with local documents describing the bank products.
This is a two-steps process:</p>
<ol>
<li>Ingest the documents into the vector database.</li>
<li>Find the relevant document and attach them to the user message (sent to the LLM).</li>
</ol>
<p>The second step is called <em>retrieval augmented generation</em> (RAG).</p>
<h3 id="ingesting-documents">Ingesting Documents<a class="headerlink" href="#ingesting-documents" title="Permanent link">#</a></h3>
<p>The first step is to ingest the documents into the vector database.
The vector database is a database used to store the documents and their vector representation.
Vectors allow semantic querying of the documents, for example, to find semantically relevant documents.</p>
<p>To the ingestion consists of reading documents and computing a vector representation for each of them.
This representation is called an <em>embedding</em>.
Then, the vector and the document are stored into the vector database.</p>
<p>In this application, we use Redis as a vector database.
The <code>pom.xml</code> file contains the following dependency:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkiverse.langchain4j<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-langchain4j-redis<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>${quarkus-langchain.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>
<details class="info" open="open">
<summary>Info</summary>
<p>Quarkus also supports Chroma and PostgreSQL as a vector database.</p>
</details>
<p>The ingestion process is implemented in the <code>DocumentIngestor</code> class:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.workshop.chat</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.Document</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.loader.FileSystemDocumentLoader</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.parser.TextDocumentParser</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.model.embedding.EmbeddingModel</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.store.embedding.EmbeddingStoreIngestor</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.redis.RedisEmbeddingStore</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.runtime.StartupEvent</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.event.Observes</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">dev.langchain4j.data.document.splitter.DocumentSplitters.recursive</span><span class="p">;</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DocumentIngestor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="cm">     * The embedding store (the database).</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="cm">     * The bean is provided by the quarkus-langchain4j-redis extension.</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="cm">     */</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">    </span><span class="n">RedisEmbeddingStore</span><span class="w"> </span><span class="n">store</span><span class="p">;</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="cm">     * The embedding model (how the vector of a document is computed).</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="cm">     * The bean is provided by the LLM (like openai) extension.</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="cm">     */</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="w">    </span><span class="n">EmbeddingModel</span><span class="w"> </span><span class="n">embeddingModel</span><span class="p">;</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ingest</span><span class="p">(</span><span class="nd">@Observes</span><span class="w"> </span><span class="n">StartupEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&quot;Ingesting documents...%n&quot;</span><span class="p">);</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Document</span><span class="o">&gt;</span><span class="w"> </span><span class="n">documents</span><span class="w"> </span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">FileSystemDocumentLoader</span><span class="p">.</span><span class="na">loadDocuments</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&quot;src/main/resources/catalog&quot;</span><span class="p">).</span><span class="na">toPath</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TextDocumentParser</span><span class="p">());</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">ingestor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmbeddingStoreIngestor</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingStore</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="w">                </span><span class="p">.</span><span class="na">embeddingModel</span><span class="p">(</span><span class="n">embeddingModel</span><span class="p">)</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="w">                </span><span class="p">.</span><span class="na">documentSplitter</span><span class="p">(</span><span class="n">recursive</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a><span class="w">        </span><span class="n">ingestor</span><span class="p">.</span><span class="na">ingest</span><span class="p">(</span><span class="n">documents</span><span class="p">);</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&quot;Ingested %d documents.%n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">documents</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>ingest</code> method is called when the application starts.
It uses the <code>FileSystemDocumentLoader</code> to load the documents from the <code>src/main/resources/catalog</code> directory.
Then, it uses the <code>EmbeddingStoreIngestor</code> to ingest the documents into the vector database.</p>
<p>The ingestor computes the embedding but also splits the document into smaller chunks.
This is required to improve the performance (and reduce the size of the relevant data attached to the user request) of the retrieval process.</p>
<details class="tip" open="open">
<summary>Tip</summary>
<p>You do not have to use the embedding model provided by the LLM extension.
You can also use a local model. It is recommended to use a local model when using a remote LLM to avoid having to send the full content to the remote LLM.</p>
</details>
<p>In this example, we ingest documents during the application startup.
However, it can be a dynamic process, ingesting documents on the fly.
In general, the ingestion and the retrieval processes are decoupled into two different applications.</p>
<h3 id="implementing-the-rag-pattern">Implementing the RAG Pattern<a class="headerlink" href="#implementing-the-rag-pattern" title="Permanent link">#</a></h3>
<p>Let&rsquo;s implement the second step.
The RAG pattern is implemented in the <code>DocumentRetriever</code> class:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.workshop.chat</span><span class="p">;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.data.segment.TextSegment</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.model.embedding.EmbeddingModel</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.retriever.EmbeddingStoreRetriever</span><span class="p">;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.retriever.Retriever</span><span class="p">;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.redis.RedisEmbeddingStore</span><span class="p">;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DocumentRetriever</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Retriever</span><span class="o">&lt;</span><span class="n">TextSegment</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">EmbeddingStoreRetriever</span><span class="w"> </span><span class="n">retriever</span><span class="p">;</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="n">DocumentRetriever</span><span class="p">(</span><span class="n">RedisEmbeddingStore</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">EmbeddingModel</span><span class="w"> </span><span class="n">model</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">        </span><span class="n">retriever</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmbeddingStoreRetriever</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">TextSegment</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findRelevant</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">retriever</span><span class="p">.</span><span class="na">findRelevant</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="p">}</span>
</code></pre></div>
<p>This class is a bean implementing the <code>Retriever</code> interface.
Because we have only one <code>Retriever</code> bean, we do not have to configure anything.
When you have multiple ones, you can configure the one to use with the <code>retriever</code> attribute of the <code>@RegisterAiService</code> annotation.</p>
<p>The retriever is configured with the vector database and the embedding model.
Then, when the user sends a request, the <code>findRelevant</code> method is called to find all the semantically relevant <em>chunks of data</em>.
The chunks are then attached to the user message and sent to the LLM.</p>
<p>To find the relevant chunks, the retriever computes the vector representation of the user query and asks the database to provide the most relevant chunks.</p>
<p>You do not have to do anything about the attachment of the chunks to the user message; it is done automatically by the LLM extension.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">#</a></h2>
<p>That concludes the second slot of the workshop.
We have seen how to use a local (or hosted) LLM (LLAMA2) to build a chat bot.
We have also looked into the ingestion and RAG patterns to extend the LLM with local documents.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information, adapter to have the Red Hat footer -->
<div class="md-copyright">
    <div class="md-copyright__highlight">
        Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" alt="Red Hat" src="../../assets/redhat_reversed.svg"/></a> <br/>
        <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> |
        <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
    
    Made with
    <a
            href="https://squidfunk.github.io/mkdocs-material/"
            target="_blank" rel="noopener"
    >
        Material for MkDocs
    </a>
    
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.indexes", "navigation.sections", "navigation.expand", "navigation.tracking", "content.code.copy", "toc.follow", "content.action.edit"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>